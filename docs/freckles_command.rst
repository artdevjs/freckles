############
``freckles``
############

Description
***********

``freckles`` is an application that downloads a remote code or data repository (a '*freckle*') that is structured according to one or some conventions. After download, ``freckles`` will execute pre-defined tasks appropriate for the type of *freckle* in question.

In order to handle those different data/code profiles, ``freckles`` can be extended with so called *adapters*. For example, if the `freckle` is a python project, ``freckles`` will use the ``python-dev`` adapter which will create a virtualenv (after, if necessary, downloading everything that is needed to create virtualenvs in the first place), download and install all dependencies it can find in any potential ``requirement_*.txt`` files, and then execute either ``pip install -e .`` or  ``python setup.py develop`` inside the created virtualenv.

Or, the `freckle` is a folder containing subfolders which in turn contain `dotfiles` (that's what configuration files are called in Unix-land). ``freckles`` will download this repo, install potentially configured applications that relate to the configuration files, and symbolically link those configuration files to the appropriate places.


Application interface
*********************

.. admonition:: (Autogenerated) cli help

    .. click:: freckles.freckles_cli:cli
       :prog: freckles
       :link-command-prefix: adapters


Details
*******

Adapters & profiles
===================

Currently, only 2 types/profiles of data are supported by *freckles*: :doc:`dotfiles </adapters/dotfiles>` and :doc:`python dev projects </adapters/python-dev>`. To encourage the creation of lots of adapters, in order to support lots of different data-types, *freckles* tries to make it as easy as possible to create new adapters, and add those adapters to your environment.

Adapter locations/naming
------------------------

By default *freckles* comes with a (small) set of 'officially supported' adapters. In addition, by default it checks one other folder for more available adapters: ``$HOME/.freckles/adapters``. Additional locations can be specified by adding either git repository urls or local paths to the ``trusted-repos`` config option of the *freckles* config file (``$HOME/.freckles/config.yml``). To easily add and retrieve an existing git repo that contains adapters (or roles, for that matter), you can use the ``enable-repo`` *frecklecutable*:

.. code-block:: console

   frecklecute enable-repo gh:makkus/freckles_roles_and_adapters

This will add the git repo url to the ``trusted-repos`` key in  ``$HOME/.freckles/config.yml``, and check out the repository into a location using a unique path (``$HOME/.local/freckles/repos/https/github/com/makkus/freckles/roles/and/adapters/git in this case``) where *freckles* will find it in subsequent runs.

*freckles* will look at all files in the configured folders and check if any of them contains a file that ends with the string ``.freckle-adapter``. If one (or several) is found, it'll assume the name of the adapter is the first part of the file-name (everything before ``.freckle-adapter``). Then it'll look for two other files in the same folder, starting with the (same) adapter name and ending with either ``freckle-init`` or ``freckle-tasks``. Only one of those two needs to exist (which one doesn't matter), but it's also possible for both of those to be there. ``freckle-init`` contains tasks that are 'adapter-specific' (tasks that need to be done the same way -- and only once -- for every *freckle* that is processed), ``freckle-tasks`` contains tasks that are 'freckle-specific' (tasks that need to be done for every *freckle*), using the *freckle* specific metadata.

Available profiles
------------------

Find all locally available adapters by executing ``freckles`` with the ``--help`` option:

.. code-block:: console

   $ freckles --help
   Usage: freckles [OPTIONS] ADAPTER1 [ARGS]... [ADAPTER2 [ARGS]...]...

     Downloads a remote dataset or code (called a 'freckle') and sets up
     ...
     ...

                            * more output *

     ...
     ...
   Commands:
     debug-freckle  helper adapter, for developing other adapter
     dotfiles       installs packages, stows dotfiles
     python-dev     prepares a python development environment



Quick-start
-----------

This is a quick overview on how to create a *freckles* adapter, more in-detail information can be found :doc:`here </writing_freckles_adapters>`. *freckles adapters* use *Ansible's* configuration format (facilitating *yaml*), similar to how to create Ansible playbooks and tasks for roles. I'll assume you have some experience with *Ansible* here. If that is not the case, maybe check out the `Ansible documentation <http://docs.ansible.com/ansible/latest/playbooks_intro.html>`_ before continuing here.

*freckles* comes with a *frecklecute* (called `'create_adapter' <https://github.com/makkus/freckles/blob/master/freckles/external/frecklecutables/create-adapter>`_ that can help you creating a *freckles adapter* stub in ``$HOME/.freckles/adapters/<adapter_name>``:

.. code-block:: console

   frecklecute create-adapter <adapter_name>

For example, let's create an adapter that can handle projects that use Vagrant_. The adapter will, after checking out of the *freckle*, install *Vagrant* (if it is not already installed), then read the *freckle* metadata to determine whether any *Vagrant plugins* need to be installed, then installs those.

.. code-block:: console

   frecklecute create-adapter vagrant-dev-example

To see that our adapter-stub was created, we can run the *freckles* help:

.. code-block:: console

   $ freckles --help

   Usage: freckles [OPTIONS] ADAPTER1 [ARGS]... [ADAPTER2 [ARGS]...]...

   Downloads a remote dataset or code (called a 'freckle') and sets up
   your local environment to be able to handle the data, according to
   ...
   ...

                        * more help output *

   ...
   ...
   --version                       prints the version of freckles
   --help                          Show this message and exit.

   Commands:
     debug-freckle        helper adapter, for developing other adapter
     dotfiles             installs packages, stows dotfiles
     python-dev           prepares a python development environment
     vagrant-dev-example  adapter-stub, please fill in the fields as
                          approriate

     freckles is free and open source software, for more information
     visit: https://docs.freckles.io

As you can see, the ``vagrant-dev-example`` profile is created and ready to be used by *freckles*. By default it only contains a few debug tasks, which is helpful to see which metadata variables are present to be used by our adapter.

Let's clean up the help output first before we continue. To do that, edit the file ``$HOME/.freckles/adapters/vagrant-dev-example/vagrant-dev-example.freckle-adapter``, and change the ``doc`` key like like so:

.. code-block:: shell

   doc:
     help: freckle adapter to prepare a host machine for a Vagrant (https://w$
     short_help: installs Vagrant and, (optional) required plugins

To see the effect, just run ``freckles --help`` again.

I've create an example *freckle* repository with some example metadata to help developing this adapter, https://github.com/makkus/vagrant-dev-example-freckle. To see what metadata the adapter has available at runtime, we can run the adapter in it's initial state:

.. code-block:: shell

   freckles -o skippy vagrant-dev-example -f gh:makkus/vagrant-dev-example-freckle

   PLAY [name] ********************************************************************

   TASK [Gathering Facts] *********************************************************
   ok: [localhost]
   ...

                * more output *

   ...
   TASK [makkus.freckles : debug freckle vars] ************************************
   ok: [localhost] => {
       "freckle_vars": {
           "vagrant_plugins": [
               "vagrant-bindfs"
           ]
       }
   }

We use the ``skippy`` output format as the default one wouldn't display any debug variables.

First order of business is to make sure *Vagrant* is installed. Since *freckles* supports the processing of multiple *freckle* folders in the same run, but it is not necessary to ensure *Vagrant* is installed for every one of those processing iterations, we put the required directives in the file called ``vagrant-dev-example.freckle-init`` (in ``$HOME/.freckles/adapters/vagrant-dev-example``). We replace the existing content of the ``vagrant-dev-example.freckle-init`` file with:

.. code-block:: yaml

   - name: checking whether to install Vagrant
     include_role:
       name: makkus.install-vagrant

This uses an already existing Ansible role that is (conveniently) shipped with *freckles*.

Now we can run *freckles* again, and see whether it does in fact install *Vagrant*:

.. code-block:: console

   $ freckles vagrant-dev-example -f gh:makkus/vagrant-dev-example-freckle

     * starting tasks (on 'localhost')...
      * applying profile(s) to freckle(s)...
        - checking out freckle(s) =>
            - https://github.com/makkus/vagrant-dev-example-freckle.git => ok (no change)
        - checking whether to install Vagrant => ok (no change)
        - creating cache download dir => ok (changed)
        - downloading Vagrant => ok (changed)
        - installing Vagrant Debian package => ok (changed)
        - deleting downloaded Vagrant install package => ok (changed)
        - debug freckle path => ok (no change)
        - debug freckle vars (raw) => ok (no change)
        - debug freckle vars => ok (no change)
        => ok (changed)

Looks good! Those last 3 debug statements are the ones still present in the ``vagrant-dev-example.freckle-tasks`` file. Let's edit that next, and make the adapter install all the *Vagrant* plugins that are specified in the ``.freckle`` metadata file. For our example repository we know this is one plugin, 'vagrant-bindfs'.

.. code-block:: yaml

   - name: install vagrant plugins
     install:
       pkg_mgr: vagrant_plugin
       packages:
         - "{{ item }}"
     with_items:
       - "{{ freckle_vars.vagrant_plugins | default([]) }}"

(You might not recognize the ``install`` Ansible module, as it's custom written to be used with *freckles*. Check out :doc:`this page </install_module>` for more information.

Let's run the whole thing again:

.. code-block:: yaml

   freckles vagrant-dev-example -f gh:makkus/vagrant-dev-example-freckle

   * starting tasks (on 'localhost')...
    * applying profile(s) to freckle(s)...
      - checking out freckle(s) =>
          - https://github.com/makkus/vagrant-dev-example-freckle.git => ok (no change)
      - checking whether to install Vagrant => ok (no change)
      - install vagrant plugins =>
          - vagrant-bindfs (using: vagrant_plugin) => ok (changed)
      => ok (changed)

Voilà! Now we can prepare hosts for all *freckle* folders that contain code that needs *Vagrant* and potentially some *Vagrant plugins*!

As mentioned above, more documentation on the topic of writing *freckle adapters*  can be found :doc:`here </writing_freckles_adapters>`.


.. _vagrant: https://www.vagrantup.com
